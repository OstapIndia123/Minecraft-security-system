# Архитектура и модель данных (v1)

## Контекст
- Один Hub = один блок в Minecraft. Данные привязаны к уникальному ID. Перенос возможен только через API/админку.
- Hub не принимает решений — только фиксирует сигналы и отправляет события. Логика всегда на сервере.
- Потеря связи не вызывает тревогу, только фиксируется в журнале (TEST_FAILED).

## Ключевые сущности
### Space (Пространство/Объект)
- Жёсткая связь 1:1 с Hub.
- Поля: название, тип объекта, адрес, координаты, фото, контакты Х/О, часовой пояс.
- Режим охраны: `disarmed`, `armed`, `night`.

### Hub
- Уникальный ID, неизменяемый.
- 6 портов (стороны блока): `north/south/east/west/up/down`.
- Порты конфигурируются как:
  - Вход (шлейф/зона)
  - Выход (сирена/индикатор/подтверждение)

### Zone (Шлейф)
- Привязка к `hubId + side`.
- Норма — указанный уровень редстоуна (0–15). Если норма = 0, любая подача сигнала = тревога.
- Типы:
  - `instant` (нормальная)
  - `delayed` (задержанная, будущая)
  - `pass` (проходная, будущая)
  - `24h`
- Признаки:
  - участвует в ночном режиме (да/нет)
  - обход (bypass) (да/нет)

### Output (Выход)
- Привязка к `hubId + side`.
- Режимы (могут комбинироваться):
  - постановочный светодиод
  - сирена
  - подтверждение постановки через reader
- Сирена: настраиваемый интервал (например, импульс/постоянный).

### Reader (Устройство доступа)
- Имеет `readerId`, имя, привязку к Space.
- Сканирует `keyName` (имя предмета), игрок игнорируется.
- Настройки ключа: доступные группы/режимы, быстрый генератор ключей.

### User / Engineer
- User: постановка/снятие/ночной режим, доступ только к своему Space.
- Engineer/ПЦН: управление конфигурацией зон/выходов/читателей, журнал по всем объектам.

## Событийная модель
### Входящие события (Hub/Reader -> API)
- `PORT_IN`: изменение уровня на стороне Hub.
- `TEST_OK`/`TEST_FAILED`: тест канала.
- `HUB_PING`: периодический ping Hub.
- `READER_SCAN`: скан ключа.

### Выходящие команды (API -> Hub)
- Управление выходами (`PORT_OUT`): включить/выключить уровень на стороне Hub.

## Логика охраны (коротко)
1. Hub отправляет событие изменения уровня.
2. Backend проверяет:
   - режим охраны
   - тип зоны
   - нормальный уровень
   - признак bypass
3. При тревоге:
   - лог события
   - включение сирен
   - визуальная индикация

## Тест канала
- Периодичность: каждые 5 минут.
- TEST_FAILED = Hub не в сети.

