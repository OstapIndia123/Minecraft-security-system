# –ë–´–°–¢–†–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–õ–ê–î–ö–ï HUB_EXTENSION

## üéØ –¶–µ–ª—å
–í—ã—è—Å–Ω–∏—Ç—å, –ø–æ—á–µ–º—É –º–æ–¥—É–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ù–ï —É—Ö–æ–¥–∏—Ç –≤ –æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ PORT_IN —Å–æ–±—ã—Ç–∏–π, –Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è SET_OUTPUT.

## üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **PROBLEM-ANALYSIS.md** - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã
2. **DIAGNOSTIC-PATCH.js** - –≥–æ—Ç–æ–≤—ã–π –ø–∞—Ç—á —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ –ª–æ–≥–∞–º–∏
3. **diagnostic-logs-patch.js** - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

## üöÄ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—á

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `backend/server.js` –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ

2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–∞—Ç—á–∏ –∏–∑ —Ñ–∞–π–ª–∞ `DIAGNOSTIC-PATCH.js`:
   - **–ü–ê–¢–ß 1** (—Å—Ç—Ä–æ–∫–∞ ~2550): –õ–æ–≥–∏ –≤ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ isExtensionEvent
   - **–ü–ê–¢–ß 2** (—Å—Ç—Ä–æ–∫–∞ ~2593): –õ–æ–≥–∏ –¥–ª—è PORT_IN –æ—Ç —Ö–∞–±–∞
   - **–ü–ê–¢–ß 3** (—Å—Ç—Ä–æ–∫–∞ ~2438): –ó–∞–º–µ–Ω–∞ checkHubExtensionLink —Å –ª–æ–≥–∞–º–∏
   - **–ü–ê–¢–ß 4** (—Å—Ç—Ä–æ–∫–∞ ~2430): –ó–∞–º–µ–Ω–∞ updateExtensionStatus —Å –ª–æ–≥–∞–º–∏
   - **–ü–ê–¢–ß 5** (—Å—Ç—Ä–æ–∫–∞ ~618): –ó–∞–º–µ–Ω–∞ resolveHubPortWaiter —Å –ª–æ–≥–∞–º–∏

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```bash
docker-compose restart app
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
docker-compose logs -f app | grep -E "HUB_EXT|CHECK_LINK|UPDATE_STATUS|RESOLVE_WAITER"
```

–ò–ª–∏ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –ª–æ–≥–æ–≤:
```bash
docker-compose logs -f app
```

### –®–∞–≥ 4: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥—É–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **–§–∏–∑–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å –æ—Ç —Ö–∞–±–∞** (—Ä–∞–∑–æ—Ä–≤–∏—Ç–µ —Å–≤—è–∑—å)
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏

### –®–∞–≥ 5: –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:

#### ‚úÖ –î–ª—è SET_OUTPUT (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å):
```
[HUB_EXT DEBUG] type: SET_OUTPUT
[HUB_EXT DEBUG] isTestSideEvent: false
[HUB_EXT DEBUG] üîç –í—ã–∑—ã–≤–∞–µ–º checkHubExtensionLink()...
[CHECK_LINK DEBUG] checkHubExtensionLink()
[CHECK_LINK DEBUG] ‚ùå –ù–ï –ø–æ–ª—É—á–∏–ª–∏ HIGH —Å–∏–≥–Ω–∞–ª!
[UPDATE_STATUS DEBUG] ‚Üí nextStatus: –ù–µ –≤ —Å–µ—Ç–∏
[UPDATE_STATUS DEBUG] ‚úÖ –°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!
```

#### ‚ùå –î–ª—è PORT_IN (–ø—Ä–æ–±–ª–µ–º–∞):
```
[HUB_EXT DEBUG] type: PORT_IN
[HUB_EXT DEBUG] isTestSideEvent: true  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
[HUB_EXT DEBUG] ‚ùå –°–æ–±—ã—Ç–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –¢–ï–°–¢–û–í–û–ï
[HUB_EXT DEBUG] ‚ùå checkHubExtensionLink() –ù–ï –ë–£–î–ï–¢ –í–´–ó–í–ê–ù!  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
```

### –®–∞–≥ 6: –ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

1. **–ü—Ä–∏—Ö–æ–¥—è—Ç –ª–∏ PORT_IN —Å–æ–±—ã—Ç–∏—è –æ—Ç –º–æ–¥—É–ª—è?**
   - –ò—â–∏—Ç–µ `[HUB_EXT DEBUG] type: PORT_IN`
   
2. **–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ isTestSideEvent –¥–ª—è PORT_IN?**
   - –ò—â–∏—Ç–µ `[HUB_EXT DEBUG] isTestSideEvent: true`
   
3. **–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ª–∏ checkHubExtensionLink() –¥–ª—è PORT_IN?**
   - –ò—â–∏—Ç–µ `[HUB_EXT DEBUG] üîç –í—ã–∑—ã–≤–∞–µ–º checkHubExtensionLink()...`
   
4. **–ï—Å–ª–∏ –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è - –ø–æ—á–µ–º—É?**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è `isTestSetOutput` –∏ `isTestSideEvent`
   
5. **–ö–∞–∫–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã —É —Å–æ–±—ã—Ç–∏—è –∏ –º–æ–¥—É–ª—è?**
   - –ò—â–∏—Ç–µ `[HUB_EXT DEBUG] ‚Üí –ê–Ω–∞–ª–∏–∑ —Å—Ç–æ—Ä–æ–Ω:`
   - `extensionSide` (—Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –º–æ–¥—É–ª—è)
   - `eventSide` (—Å—Ç–æ—Ä–æ–Ω–∞ –∏–∑ —Å–æ–±—ã—Ç–∏—è)

### –®–∞–≥ 7: –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ:

1. **PORT_IN —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç** —Å `eventSide === extensionSide`
2. **isTestSideEvent = true** –¥–ª—è —ç—Ç–∏—Ö —Å–æ–±—ã—Ç–∏–π
3. **checkHubExtensionLink() –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** –∏–∑-–∑–∞ —Ä–∞–Ω–Ω–µ–≥–æ return
4. **–ú–æ–¥—É–ª—å –ù–ï –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "–ù–µ –≤ —Å–µ—Ç–∏"**

## üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∞—Ö, –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

### –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä–æ—Å—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–í —Ñ–∞–π–ª–µ `backend/server.js`, —Å—Ç—Ä–æ–∫–∞ ~2572, –∏–∑–º–µ–Ω–∏—Ç–µ:

```javascript
// –ë–´–õ–û:
const isTestSideEvent = Boolean(
    eventSide
    && extensionSide
    && eventSide === extensionSide,
);

// –°–¢–ê–õ–û:
const isTestSideEvent = Boolean(
    type !== 'PORT_IN'  // ‚Üê –ù–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫ PORT_IN!
    && eventSide
    && extensionSide
    && eventSide === extensionSide,
);
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–£–¥–∞–ª–∏—Ç—å `isTestSideEvent` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `isTestSetOutput`:

```javascript
const isTestSetOutput = Boolean(
    type === 'SET_OUTPUT'
    && eventSide
    && extensionSide
    && (eventSide === extensionSide || eventSide === mirrorExtensionSide)
    && (eventLevel === 0 || eventLevel === 15)  // ‚Üê –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
);

// –£–¥–∞–ª–∏—Ç—å isTestSideEvent

if (isTestSetOutput) {
    return res.status(202).json({ ok: true, ignored: true });
}
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose restart app`
2. –û—Ç–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å –æ—Ç —Ö–∞–±–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - ‚úÖ `checkHubExtensionLink()` –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è
   - ‚úÖ `updateExtensionStatus()` –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ù–µ –≤ —Å–µ—Ç–∏"
   - ‚úÖ –°–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å `extensionOffline: true`
4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å –æ–±—Ä–∞—Ç–Ω–æ
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ "–°–Ω–æ–≤–∞ –≤ —Å–µ—Ç–∏"
   - ‚úÖ –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

## üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ:
- –õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω)
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ñ–∞–π–ª–µ **PROBLEM-ANALYSIS.md**

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

1. –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `backend/server.js` –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å JavaScript –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫: `docker-compose logs app | grep -i error`

---

**–£—Å–ø–µ—Ö–æ–≤ –≤ –æ—Ç–ª–∞–¥–∫–µ! üöÄ**
